version: '3'

vars:
  VENV: .venv
  BACKEND_DIR: backend
  FRONTEND_DIR: frontend
  QDRANT_LOCK: local_qdrant/.lock

tasks:
  run:
    desc: "Run the app (backend + frontend servers)"
    cmds:
      - task: kill-ports
      - task: clean-lock
      - task: start-backend
      - task: start-frontend
      - echo "======================================"
      - echo "NYC Event Recommender is ready!"
      - echo "======================================"
      - echo "Backend at http://localhost:8000"
      - echo "Frontend at http://localhost:3000"
      - echo "Press Ctrl+C to stop or run task stop"
      - task: open-frontend
      - echo "Tip - View logs with task logs"
      - echo "Tip - Stop servers with task stop"
      - sh -c "while true; do sleep 3600; done"
    silent: false

  kill-ports:
    desc: "Kill processes using ports 8000 and 3000"
    cmds:
      - echo "ðŸ”ª Killing processes on ports 8000 and 3000..."
      - sh -c "lsof -ti:8000 | xargs kill -9 2>/dev/null || true"
      - sh -c "lsof -ti:3000 | xargs kill -9 2>/dev/null || true"
      - echo "âœ… Ports cleared"
    silent: false

  clean-lock:
    desc: "Remove Qdrant database lock"
    cmds:
      - echo "ðŸ”“ Clearing Qdrant lock..."
      - rm -f {{.QDRANT_LOCK}}
      - echo "âœ… Lock cleared"

  start-backend:
    desc: "Start the FastAPI backend server"
    cmds:
      - echo "ðŸš€ Starting backend server..."
      - sh -c "{{.VENV}}/bin/python -m uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000 > backend.log 2>&1 &"
      - echo "â³ Waiting for backend to start..."
      - sleep 3
      - sh -c "if curl -s http://localhost:8000/health > /dev/null 2>&1; then echo 'âœ… Backend is running on http://localhost:8000'; else echo 'âŒ Backend failed to start. Check backend.log for errors.'; exit 1; fi"
    silent: false

  start-frontend:
    desc: "Start the frontend HTTP server"
    cmds:
      - echo "ðŸŒ Starting frontend server..."
      - sh -c "cd {{.FRONTEND_DIR}} && if command -v python3 > /dev/null 2>&1; then python3 -m http.server 3000 > ../frontend.log 2>&1 & else python -m http.server 3000 > ../frontend.log 2>&1 & fi"
      - sleep 1
      - sh -c "if curl -s http://localhost:3000 > /dev/null 2>&1; then echo 'âœ… Frontend server running on http://localhost:3000'; else echo 'âš ï¸  Frontend server starting (may take a moment)...'; fi"
    silent: false

  open-frontend:
    desc: "Open the frontend in browser"
    cmds:
      - echo "ðŸŒ Opening frontend..."
      - sleep 1
      - open http://localhost:3000 || xdg-open http://localhost:3000
      - echo "Frontend opened at http://localhost:3000"

  stop:
    desc: "Stop all running servers"
    cmds:
      - echo "ðŸ›‘ Stopping servers..."
      - task: kill-ports
      - task: clean-lock
      - echo "âœ… All servers stopped"
    silent: false

  logs:
    desc: "View server logs"
    cmds:
      - echo "Server logs (Ctrl+C to exit)"
      - sh -c "tail -f backend.log frontend.log 2>/dev/null || echo 'No log files found. Start servers with task run'"
