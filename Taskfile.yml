version: '3'

vars:
  VENV: .venv
  BACKEND_DIR: backend
  FRONTEND_DIR: frontend
  QDRANT_LOCK: local_qdrant/.lock

tasks:
  run:
    desc: "Run the app (backend + frontend servers)"
    cmds:
      - task: kill-ports
      - task: clean-lock
      - task: start-backend
      - task: start-frontend
      - sleep 2
      - task: open-frontend
    silent: false

  kill-ports:
    desc: "Kill processes using ports 8000 and 3000"
    cmds:
      - echo "ğŸ”ª Killing processes on ports 8000 and 3000..."
      - sh -c "lsof -ti:8000 | xargs kill -9 2>/dev/null || true"
      - sh -c "lsof -ti:3000 | xargs kill -9 2>/dev/null || true"
      - echo "âœ… Ports cleared"
    silent: false

  clean-lock:
    desc: "Remove Qdrant database lock"
    cmds:
      - echo "ğŸ”“ Clearing Qdrant lock..."
      - rm -f {{.QDRANT_LOCK}}
      - echo "âœ… Lock cleared"

  start-backend:
    desc: "Start the FastAPI backend server"
    dir: "{{.BACKEND_DIR}}"
    cmds:
      - echo "ğŸš€ Starting backend server..."
      - sh -c "source ../{{.VENV}}/bin/activate && python -m uvicorn main:app --reload --host 0.0.0.0 --port 8000 > /dev/null 2>&1 &"
      - echo "âœ… Backend starting on http://localhost:8000"
    silent: false

  start-frontend:
    desc: "Start the frontend HTTP server"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - echo "ğŸŒ Starting frontend server..."
      - sh -c "if command -v python3 > /dev/null 2>&1; then python3 -m http.server 3000 > /dev/null 2>&1 & else python -m http.server 3000 > /dev/null 2>&1 & fi"
      - echo "âœ… Frontend server starting on http://localhost:3000"
    silent: false

  open-frontend:
    desc: "Open the frontend in browser"
    cmds:
      - echo "ğŸŒ Opening frontend..."
      - sleep 1
      - open http://localhost:3000 || xdg-open http://localhost:3000
      - echo "âœ… Frontend opened at http://localhost:3000"
